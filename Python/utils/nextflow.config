// Generic Nextflow Configuration for Python-based Analysis Pipelines
// Works with python_dispatcher pattern and participant-based output directories
// Suitable for any multi-participant data analysis workflow

// Process configuration - optimized for python_dispatcher tasks
process {
    // Error handling: 'ignore' means failed processes are skipped (no output emitted)
    // but the workflow continues. Other branches and participants are not affected.
    // The finalizer uses groupTuple(size: 15, remainder: true) to handle partial results.
    errorStrategy = { task.exitStatus in [137,140] ? 'retry' : 'ignore' }
    maxRetries = 3

    // Dynamic resource allocation - scales with retry attempts
    memory = { 2.GB * task.attempt }
    cpus = 2
    
    // Process-specific resource allocation
    withName: 'ic_analyzer' {
        memory = { 8.GB * task.attempt }
        cpus = 4
        maxRetries = 3
    }

    // Force file copy for staging to avoid symlink issues on Windows/WSL mounts
    stageInMode = 'copy'
    stageOutMode = 'copy'

    // Optional: Add conda/container support for reproducibility
    // conda = 'path/to/environment.yml'
    // container = 'your-analysis-container'
}

// Executor configuration - optimized for local multi-core execution
executor {
    name = 'local'
    cpus = 16           // Adjust to your system's cores
    memory = '31 GB'   // Adjust to your system's RAM
}

// Comprehensive pipeline monitoring and reporting
timeline {
    enabled = false                  // Disabled - not needed, causes warnings on manual termination
    file = "pipeline_timeline.html"
}

report {
    enabled = false                  // Disabled - not needed, causes warnings on manual termination
    file = "pipeline_report.html"
}

trace {
    enabled = true
    file = "pipeline_trace.txt"      // Complete process trace with all metrics
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt,env,workdir,script,scratch'
}

// Logging configuration
log {
    level = 'INFO'
    file = "nextflow.log"            // Main execution log
}

// Work directory management - useful for debugging and log access
cleanup = false                     // Set to true for production to save disk space

// Note: Per-participant completion is handled by watchdog threads in workflow_wrapper
// Git sync happens automatically when each participant's terminal processes complete